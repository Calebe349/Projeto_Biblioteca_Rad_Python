import sqlite3
import tkinter as tk
from tkinter import ttk, messagebox
from datetime import datetime, timedelta

NOME_BD = "biblioteca.db"


class Biblioteca:
    def __init__(self):
        self.conn = sqlite3.connect(NOME_BD)
        self.criar_tabelas()

    def criar_tabelas(self):
        cursor = self.conn.cursor()
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS generos (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                nome TEXT UNIQUE NOT NULL
            )
        """)
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS livros (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                titulo TEXT NOT NULL,
                autor TEXT NOT NULL,
                genero_id INTEGER,
                FOREIGN KEY (genero_id) REFERENCES generos(id)
            )
        """)
        self.conn.commit()

        cursor.execute("PRAGMA table_info(livros)")
        colunas = [linha[1] for linha in cursor.fetchall()]

        if "status" not in colunas:
            cursor.execute("ALTER TABLE livros ADD COLUMN status TEXT DEFAULT 'Disponível'")
        if "data_retorno" not in colunas:
            cursor.execute("ALTER TABLE livros ADD COLUMN data_retorno TEXT")

        self.conn.commit()

    def adicionar_livro(self, genero, titulo, autor):
        cursor = self.conn.cursor()
        cursor.execute("SELECT id FROM generos WHERE nome = ?", (genero,))
        resultado = cursor.fetchone()

        if resultado:
            genero_id = resultado[0]
        else:
            cursor.execute("INSERT INTO generos (nome) VALUES (?)", (genero,))
            genero_id = cursor.lastrowid

        cursor.execute("""
            INSERT INTO livros (titulo, autor, genero_id, status)
            VALUES (?, ?, ?, 'Disponível')
        """, (titulo, autor, genero_id))
        self.conn.commit()

    def listar_livros(self):
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT l.id, l.titulo, l.autor, g.nome, l.status, l.data_retorno
            FROM livros l
            JOIN generos g ON l.genero_id = g.id
            ORDER BY g.nome
        """)
        return cursor.fetchall()

    def remover_livro(self, livro_id):
        cursor = self.conn.cursor()
        cursor.execute("DELETE FROM livros WHERE id = ?", (livro_id,))
        self.conn.commit()

    def buscar_livros(self, termo):
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT l.id, l.titulo, l.autor, g.nome, l.status, l.data_retorno
            FROM livros l
            JOIN generos g ON l.genero_id = g.id
            WHERE l.titulo LIKE ? OR l.autor LIKE ? OR g.nome LIKE ?
        """, (f"%{termo}%", f"%{termo}%", f"%{termo}%"))
        return cursor.fetchall()

    def alugar_livro(self, livro_id, dias=7):
        data_retorno = (datetime.now() + timedelta(days=dias)).strftime("%Y-%m-%d")
        cursor = self.conn.cursor()
        cursor.execute("""
            UPDATE livros
            SET status = 'Alugado', data_retorno = ?
            WHERE id = ?
        """, (data_retorno, livro_id))
        self.conn.commit()

    def devolver_livro(self, livro_id):
        cursor = self.conn.cursor()
        cursor.execute("""
            UPDATE livros
            SET status = 'Disponível', data_retorno = NULL
            WHERE id = ?
        """, (livro_id,))
        self.conn.commit()


class AppBiblioteca(tk.Tk):
    def __init__(self):
        super().__init__()
        self.biblioteca = Biblioteca()
        self.title("Sistema de Biblioteca")
        self.geometry("880x540")
        self.configure(bg="#f5f0e6")

        self.criar_interface()
        self.atualizar_tabela()

    def criar_interface(self):
        titulo = tk.Label(
            self, text="Sistema de Biblioteca", font=("Segoe UI", 22, "bold"),
            fg="#7b2c3b", bg="#f5f0e6"
        )
        titulo.pack(pady=10)

        frame_form = tk.Frame(self, bg="#f5f0e6")
        frame_form.pack(pady=10)

        tk.Label(frame_form, text="Gênero:", bg="#f5f0e6", fg="#7b2c3b").grid(row=0, column=0, padx=5)
        tk.Label(frame_form, text="Título:", bg="#f5f0e6", fg="#7b2c3b").grid(row=0, column=2, padx=5)
        tk.Label(frame_form, text="Autor:", bg="#f5f0e6", fg="#7b2c3b").grid(row=0, column=4, padx=5)

        self.campo_genero = tk.Entry(frame_form, width=15)
        self.campo_titulo = tk.Entry(frame_form, width=25)
        self.campo_autor = tk.Entry(frame_form, width=20)

        self.campo_genero.grid(row=0, column=1, padx=5)
        self.campo_titulo.grid(row=0, column=3, padx=5)
        self.campo_autor.grid(row=0, column=5, padx=5)

        tk.Button(
            self, text="Adicionar Livro", command=self.adicionar_livro,
            bg="#7b2c3b", fg="white", font=("Segoe UI", 11, "bold"),
            relief="flat", width=18, height=2
        ).pack(pady=5)

        frame_busca = tk.Frame(self, bg="#f5f0e6")
        frame_busca.pack(pady=10)

        tk.Label(frame_busca, text="Buscar:", bg="#f5f0e6", fg="#7b2c3b").pack(side=tk.LEFT, padx=5)
        self.campo_busca = tk.Entry(frame_busca, width=30)
        self.campo_busca.pack(side=tk.LEFT, padx=5)
        tk.Button(
            frame_busca, text="Pesquisar", command=self.buscar_livros,
            bg="#7b2c3b", fg="white", relief="flat", width=12
        ).pack(side=tk.LEFT, padx=5)

        colunas = ("ID", "Título", "Autor", "Gênero", "Status", "Disponível em")
        self.tabela = ttk.Treeview(self, columns=colunas, show="headings", height=10)
        for col in colunas:
            self.tabela.heading(col, text=col)
            self.tabela.column(col, anchor=tk.CENTER, width=130)

        estilo = ttk.Style()
        estilo.configure("Treeview.Heading", font=("Segoe UI", 10, "bold"))
        estilo.configure("Treeview", font=("Segoe UI", 10), rowheight=25)
        self.tabela.pack(pady=10, fill="both", expand=True)

        frame_botoes = tk.Frame(self, bg="#f5f0e6")
        frame_botoes.pack(pady=10)

        tk.Button(
            frame_botoes, text="Alugar Livro", command=self.alugar_selecionado,
            bg="#7b2c3b", fg="white", font=("Segoe UI", 11, "bold"),
            relief="flat", width=18, height=2
        ).grid(row=0, column=0, padx=5)

        tk.Button(
            frame_botoes, text="Devolver Livro", command=self.devolver_selecionado,
            bg="#7b2c3b", fg="white", font=("Segoe UI", 11, "bold"),
            relief="flat", width=18, height=2
        ).grid(row=0, column=1, padx=5)

        tk.Button(
            frame_botoes, text="Remover Livro", command=self.remover_selecionado,
            bg="#7b2c3b", fg="white", font=("Segoe UI", 11, "bold"),
            relief="flat", width=18, height=2
        ).grid(row=0, column=2, padx=5)

    def adicionar_livro(self):
        genero = self.campo_genero.get().strip()
        titulo = self.campo_titulo.get().strip()
        autor = self.campo_autor.get().strip()

        if not (genero and titulo and autor):
            messagebox.showwarning("Aviso", "Preencha todos os campos!")
            return

        self.biblioteca.adicionar_livro(genero, titulo, autor)
        messagebox.showinfo("Sucesso", f"Livro '{titulo}' adicionado com sucesso!")
        self.campo_genero.delete(0, tk.END)
        self.campo_titulo.delete(0, tk.END)
        self.campo_autor.delete(0, tk.END)
        self.atualizar_tabela()

    def atualizar_tabela(self):
        for item in self.tabela.get_children():
            self.tabela.delete(item)

        for livro in self.biblioteca.listar_livros():
            livro_id, titulo, autor, genero, status, data_retorno = livro
            if status == "Disponível":
                disponibilidade = "Disponível"
            else:
                if data_retorno:
                    dias = (datetime.strptime(data_retorno, "%Y-%m-%d") - datetime.now()).days
                    disponibilidade = f"em {dias} dias" if dias > 0 else "Hoje"
                else:
                    disponibilidade = "-"
            self.tabela.insert("", tk.END, values=(livro_id, titulo, autor, genero, status, disponibilidade))

    def buscar_livros(self):
        termo = self.campo_busca.get().strip()
        resultados = self.biblioteca.buscar_livros(termo)

        for item in self.tabela.get_children():
            self.tabela.delete(item)

        for livro in resultados:
            livro_id, titulo, autor, genero, status, data_retorno = livro
            if status == "Disponível":
                disponibilidade = "Disponível"
            else:
                if data_retorno:
                    dias = (datetime.strptime(data_retorno, "%Y-%m-%d") - datetime.now()).days
                    disponibilidade = f"em {dias} dias"
                else:
                    disponibilidade = "-"
            self.tabela.insert("", tk.END, values=(livro_id, titulo, autor, genero, status, disponibilidade))

    def remover_selecionado(self):
        selecao = self.tabela.selection()
        if not selecao:
            messagebox.showwarning("Aviso", "Selecione um livro para remover.")
            return
        livro_id = self.tabela.item(selecao[0])["values"][0]
        self.biblioteca.remover_livro(livro_id)
        messagebox.showinfo("Removido", "Livro removido com sucesso!")
        self.atualizar_tabela()

    def alugar_selecionado(self):
        selecao = self.tabela.selection()
        if not selecao:
            messagebox.showwarning("Aviso", "Selecione um livro para alugar.")
            return
        livro_id, _, _, _, status, _ = self.tabela.item(selecao[0])["values"]
        if status == "Alugado":
            messagebox.showinfo("Indisponível", "Este livro já está alugado.")
            return
        self.biblioteca.alugar_livro(livro_id)
        messagebox.showinfo("Sucesso", "Livro alugado por 7 dias.")
        self.atualizar_tabela()

    def devolver_selecionado(self):
        selecao = self.tabela.selection()
        if not selecao:
            messagebox.showwarning("Aviso", "Selecione um livro para devolver.")
            return
        livro_id, _, _, _, status, _ = self.tabela.item(selecao[0])["values"]
        if status == "Disponível":
            messagebox.showinfo("Atenção", "Este livro já está disponível.")
            return
        self.biblioteca.devolver_livro(livro_id)
        messagebox.showinfo("Sucesso", "Livro devolvido com sucesso!")
        self.atualizar_tabela()


if __name__ == "__main__":
    app = AppBiblioteca()
    app.mainloop()
